<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="haberdashPI">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Extending Weber - Weber.jl</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  <link href="../assets/Documenter.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Extending Weber";
    var mkdocs_page_input_path = "extend.md";
    var mkdocs_page_url = "/extend/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Weber.jl</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Introduction</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>User Guide</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../start/">Getting Started</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../trial_guide/">Trial Creation</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../advanced/">Advanced Experiments</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Extending Weber</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#the-private-interface-of-run-time-objects">The private interface of run-time objects.</a></li>
                
                    <li><a class="toctree-l4" href="#custom-events">Custom Events</a></li>
                
                    <li><a class="toctree-l4" href="#custom-moments">Custom Moments</a></li>
                
            
            </ul>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Reference</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../experiment/">Experiments</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../trials/">Trials</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../sound/">Sound</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../video/">Video</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../event/">Events</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../extend_ref/">Extensions</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Weber.jl</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>User Guide &raquo;</li>
        
      
    
    <li>Extending Weber</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/haberdashPI/Weber.jl/edit/master/docs/extend.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p>Functionality can be added to Weber via extensions. You can add multiple extensions to the same experiment. To handle multiple extensions properly, so that all extensions work, the following methods have special extension machinery.</p>
<ul>
<li><a href="../experiment/#Weber.addcolumn"><code>addcolumn</code></a></li>
<li><a href="../experiment/#Weber.setup"><code>setup</code></a></li>
<li><a href="../experiment/#Base.run"><code>run</code></a></li>
<li><a href="../trials/#Weber.record"><code>record</code></a></li>
<li><a href="../trials/#Weber.addtrial"><code>addtrial</code></a></li>
<li><a href="../trials/#Weber.addbreak"><code>addbreak</code></a></li>
<li><a href="../extend_ref/#Weber.poll_events"><code>poll_events</code></a></li>
</ul>
<p>To extend one of these functions you define an extension type. For example:</p>
<pre><code class="julia">type MyExtension &lt;: Weber.Extension
  my_value::String
end
</code></pre>

<p>For all fo the public functions above (everything but <code>poll_events</code>), you define a new method of these functions that includes one additional argument beyond that listed in its documentation, located before all other arguments. This argument should be of type <code>ExtendedExperiment{MyExtension}</code>. To extend the private <code>poll_events</code> function, replace the <code>Experiment</code> argument with an <code>ExtendedExperiment{MyExtension}</code> argument.</p>
<div class="admonition warning">
<p class="admonition-title">Don't extend unlisted functions</p>
<p>These functions have specific machinery setup to make extension possible. Don't use the same approach with other functions and expect your extension to work.</p>
</div>
<p>As an example, <a href="../trials/#Weber.record"><code>record</code></a> could be extended as follows.</p>
<pre><code class="julia">function record(experiment::ExtendedExperiment{MyExtension},code;keys...)
  record(next(experiment),code;my_extension=extension(experiment).my_value,keys...)
end
</code></pre>

<p>There are a few things to note about this implementation. First, it accesses the extension object in the experiment using <code>extension</code>.</p>
<p>Second, each experiment can have multiple extensions, so each subsequent <em>version</em> of the experiment must be dispatched over. Each version of an experiment refers to the experiment paired with one of its extensions. The top-most version is the first extension specified in the call to <a href="../experiment/#Weber.Experiment"><code>Experiment</code></a>, the bottom-most the experiment without any extensions.  As all extensions should, the above method calls the function being extended (<code>record</code>) in its body, but dispatching over the next experiment version. In this way, all behavior from each extension, and the base experiment, without any extensions, is executed. The next version is accessed using the <a href="../extend_ref/#Base.next-Tuple{Weber.ExtendedExperiment}"><code>next</code></a> function.</p>
<p>For this extension to actually work, <code>setup</code> must also be extended to add the column <code>:my_extension</code> to the data file.</p>
<pre><code class="julia">function setup(fn::Function,experiment::ExtendedExperiment{MyExtension})
  setup(next(experiment)) do
    addcolumn(top(experiment),:my_extension)
    fn()
  end
end
</code></pre>

<p>This demonstrates one last important concept. When calling <code>addcolumn</code>, the function <code>top</code> is called on the experiment to get the top-most version of the experiment, so that any functionality of versions above the current one will be utilized in the call to <code>addcolumn</code>.</p>
<p><a id='The-private-interface-of-run-time-objects.-1'></a></p>
<h1 id="the-private-interface-of-run-time-objects">The private interface of run-time objects.</h1>
<p>Most of the functionality above allows the extension of <a href="../start/#setup_time-1">setup-time</a> functionality. However, there are two ways to implement new run-time functionality: the generation of new kinds of events and the creation of new kinds of moments.</p>
<p><a id='Custom-Events-1'></a></p>
<h2 id="custom-events">Custom Events</h2>
<p>Extensions to <a href="../extend_ref/#Weber.poll_events"><code>poll_events</code></a> can be used to generate new subtypes of the abstract type <code>Weber.ExpEvent</code>. These events should be tagged with the <code>@event</code> macro, to ensure proper pre-compilation of moment functions. Such events can implement new methods for the existing <a href="../event/">public functions on events</a> or their own new functions.</p>
<p>If you define new functions, instead of leveraging the existing event methods, they should generally have some default behavior for all <code>ExpEvent</code> objects, so it is easy to call the method on any event a watcher moment receives.</p>
<p><a id='Custom-Key-Events-1'></a></p>
<h3 id="custom-key-events">Custom Key Events</h3>
<p>One approach, if you are implementing events for a hardware input device, is to leverage the existing methods <a href="../event/#Weber.iskeydown"><code>iskeydown</code></a>. You can define your own type of keycode (which should be of some new custom type <code>&lt;: Weber.Key</code>). You can then make use of the <a href="../event/#Weber.@key_str"><code>@key_str</code></a> macro by adding entries to the <code>Weber.str_to_code</code> dictionary (a private global constant). So for example, you could add the following to the module implementing your extension.</p>
<pre><code class="julia">Weber.str_to_code[&quot;my_button1&quot;] = MyHardwareKey(1)
Weber.str_to_code[&quot;my_button1&quot;] = MyHardwareKey(2)
</code></pre>

<p>Such key types should implement <code>==</code>, <code>hash</code> and <code>isless</code> so that the events can be ordered. This allows them to be displayed in an organized fashion when printed using <a href="../event/#Weber.listkeys"><code>listkeys</code></a>.</p>
<p>You could then extend poll_events so that it generates events that return true for <code>iskeydown(myevent,key"my_button1")</code> (and a corresponding method for <code>iskeyup</code>). These buttons could then be used in code using your module by calling <code>response</code> as follows.</p>
<pre><code class="julia">response(key&quot;my_button1&quot; =&gt; &quot;button1_pressed&quot;,
         key&quot;my_button2&quot; =&gt; button2_pressed)
</code></pre>

<p><a id='Custom-Moments-1'></a></p>
<h2 id="custom-moments">Custom Moments</h2>
<p>You can create your own moment types, which must be <code>&lt;: Weber.Moment</code>. These new moments will have to be generated using some newly defined function, or added automatically by extending <code>addtrial</code>. Once created, and added to trials, these moments will be processed at run-time using the function <a href="../extend_ref/#Weber.handle"><code>handle</code></a>, which should define the moment's run-time behavior.</p>
<p>A moment can also define <a href="../extend_ref/#Weber.delta_t"><code>delta_t</code></a>–-to define when it occurs–-or <a href="../extend_ref/#Weber.prepare!"><code>prepare!</code></a>–-to have some sort of initialization occur before its onset–-but these both have default implementations.</p>
<p>Methods of <code>handle</code> should not make use of the extension machinery described above. What this means is that methods of <code>handle</code> should never dispatch on an extended experiment, and no calls to <code>top</code>, <code>next</code> or <code>extension</code> should occur on the experiment object. Further, each moment should belong to one specific extension, in which all functionality for that custom moment should be implemented.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../experiment/" class="btn btn-neutral float-right" title="Experiments">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../advanced/" class="btn btn-neutral" title="Advanced Experiments"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/haberdashPI/Weber.jl" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../advanced/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../experiment/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../js/theme.js"></script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../assets/mathjaxhelper.js"></script>

</body>
</html>
